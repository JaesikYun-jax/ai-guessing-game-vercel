<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상황 대처 AI 게임</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <meta name="description" content="AI와 함께하는 상황 대처 게임 - 다양한 상황에서 AI와 대화하며 목표를 달성해보세요!">
</head>
<body>
    <div class="container">
        <header>
            <h1>상황 대처 AI 게임</h1>
            <p id="server-status" class="status-message">서버 연결 확인 중...</p>
        </header>

        <!-- 게임 시작 화면 -->
        <div id="start-screen" class="screen hidden">
            <div class="card">
                <h2>게임 선택</h2>
                <p class="instruction">원하는 게임을 선택하거나 랜덤으로 시작하세요!</p>
                
                <div class="game-selection">
                    <label for="game-select">게임 시나리오:</label>
                    <select id="game-select" class="select-box">
                        <option value="">-- 게임을 선택하세요 --</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button id="start-selected-btn" class="btn primary-btn">
                        <i class="fas fa-play"></i> 선택 게임 시작
                    </button>
                    <button id="start-random-btn" class="btn secondary-btn">
                        <i class="fas fa-random"></i> 랜덤 게임 시작
                    </button>
                </div>
            </div>
            
            <div class="info-section">
                <div class="info-card">
                    <h3><i class="fas fa-info-circle"></i> 게임 안내</h3>
                    <ul>
                        <li>다양한 상황에서 AI와 대화하며 목표를 달성하는 게임입니다</li>
                        <li>각 게임마다 정해진 턴 수 내에 승리 조건을 달성해야 합니다</li>
                        <li>관련 없는 대화는 진행에 도움이 되지 않을 수 있습니다</li>
                        <li>게임 도중 언제든 종료 버튼을 눌러 게임을 끝낼 수 있습니다</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 게임 화면 -->
        <div id="game-container" class="screen hidden">
            <div class="game-header">
                <div class="game-info">
                    <p id="game-id">게임 ID: </p>
                    <p id="category">카테고리: </p>
                    <div class="turn-info">
                        <p id="turn-indicator">턴: <span id="current-turn">1</span>/<span id="max-turns">5</span></p>
                    </div>
                </div>
                <div class="game-title">
                    <h2 id="title">시나리오: </h2>
                    <p id="win-condition">승리 조건: </p>
                </div>
            </div>
            
            <div class="character-info-box">
                <p id="character-info" class="character-info"></p>
            </div>
            
            <div class="messages-container">
                <div id="message-container" class="messages"></div>
            </div>
            
            <div class="input-container">
                <textarea id="user-input" placeholder="메시지를 입력하세요..." maxlength="500"></textarea>
                <div class="input-controls">
                    <span id="char-counter" class="char-counter">0/500</span>
                    <button id="send-btn" class="btn primary-btn">
                        <i class="fas fa-paper-plane"></i> 전송
                    </button>
                </div>
                <div class="game-controls">
                    <button id="end-game-btn" class="btn danger-btn">
                        <i class="fas fa-stop-circle"></i> 게임 종료
                    </button>
                    <button id="new-game-btn" class="btn success-btn hidden">
                        <i class="fas fa-plus-circle"></i> 새 게임
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 오류 메시지 모달 -->
        <div id="error-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3><i class="fas fa-exclamation-triangle"></i> 오류 발생</h3>
                <p id="error-message">오류가 발생했습니다.</p>
                <button id="retry-btn" class="btn primary-btn">
                    <i class="fas fa-sync"></i> 다시 시도
                </button>
            </div>
        </div>
    </div>
    <footer>
        <p>&copy; 2023 상황 대처 AI 게임</p>
    </footer>
    
    <!-- 직접 스크립트 추가 (script.js는 유지) -->
    <script>
        // API 서버 URL 설정 (script.js에서 참조)
        window.API_SERVER = 'https://flask-vercel-ebon.vercel.app';
        
        // DOM 요소
        const serverStatus = document.getElementById('server-status');
        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const gameSelect = document.getElementById('game-select');
        const startSelectedBtn = document.getElementById('start-selected-btn');
        const startRandomBtn = document.getElementById('start-random-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry-btn');
        const closeBtn = document.querySelector('.close-btn');
        
        // 페이지 로드 시 서버 상태 확인 및 게임 목록 로드
        document.addEventListener('DOMContentLoaded', () => {
            console.log('페이지 로드됨, API 서버:', window.API_SERVER);
            
            // 서버 상태 확인
            checkServerStatus();
            
            // 이벤트 리스너 등록
            startSelectedBtn.addEventListener('click', () => handleStartGame('selected'));
            startRandomBtn.addEventListener('click', () => handleStartGame('random'));
            retryBtn.addEventListener('click', checkServerStatus);
            closeBtn.addEventListener('click', () => errorModal.classList.add('hidden'));
        });
        
        // 서버 상태 확인
        async function checkServerStatus() {
            try {
                console.log('서버 상태 확인 중...');
                serverStatus.textContent = '서버 연결 중...';
                serverStatus.classList.remove('success-text', 'error-text');
                
                const response = await fetch(`${window.API_SERVER}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.status === 'online') {
                    serverStatus.textContent = `✅ 서버 연결 성공 (${data.status})`;
                    serverStatus.classList.add('success-text');
                    startScreen.classList.remove('hidden');
                    
                    // 게임 목록 로드
                    fetchGameItems();
                } else if (data && data.status === 'error') {
                    // API 키가 없는 경우 등의 오류 처리
                    serverStatus.textContent = `❌ 서버 오류: ${data.message}`;
                    serverStatus.classList.add('error-text');
                    showErrorModal(`API 서버 오류: ${data.message}`);
                } else {
                    throw new Error('서버 상태가 온라인이 아닙니다');
                }
            } catch (error) {
                console.error('서버 연결 실패:', error);
                serverStatus.textContent = `❌ 서버 연결 실패: ${error.message}`;
                serverStatus.classList.add('error-text');
                showErrorModal(`서버에 연결할 수 없습니다: ${error.message}`);
            }
        }
        
        // 게임 목록 가져오기
        async function fetchGameItems() {
            try {
                console.log('게임 목록 요청 중...');
                
                const response = await fetch(`${window.API_SERVER}/api/games`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`게임 목록 요청 오류: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    window.gameItems = data.data;
                    console.log(`${window.gameItems.length}개의 게임 항목 로드됨`);
                    populateGameSelect(window.gameItems);
                } else {
                    throw new Error('게임 목록을 불러올 수 없습니다');
                }
            } catch (error) {
                console.error('게임 목록 가져오기 실패:', error);
                showErrorModal(`게임 목록을 가져올 수 없습니다: ${error.message}`);
            }
        }
        
        // 게임 선택 드롭다운 채우기
        function populateGameSelect(items) {
            // 기존 옵션 제거 (첫 번째 옵션 제외)
            while (gameSelect.options.length > 1) {
                gameSelect.remove(1);
            }
            
            // 카테고리별로 그룹화
            const categorizedItems = {};
            
            items.forEach(item => {
                const category = item.category || '기타';
                if (!categorizedItems[category]) {
                    categorizedItems[category] = [];
                }
                categorizedItems[category].push(item);
            });
            
            // 카테고리별 optgroup 생성
            for (const category in categorizedItems) {
                const group = document.createElement('optgroup');
                group.label = category;
                
                // 해당 카테고리의 게임들 추가
                categorizedItems[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.title} (${item.difficulty || '보통'}, ${item.max_turns}턴)`;
                    group.appendChild(option);
                });
                
                gameSelect.appendChild(group);
            }
        }
        
        // 게임 시작 핸들러 
        async function handleStartGame(mode) {
            try {
                // 선택 모드에서 게임 ID 확인
                let selectedGameId = null;
                if (mode === 'selected') {
                    selectedGameId = gameSelect.value;
                    if (!selectedGameId) {
                        alert('게임을 선택해주세요.');
                        return;
                    }
                }
                
                // 버튼 비활성화
                startSelectedBtn.disabled = true;
                startRandomBtn.disabled = true;
                
                // API 요청
                const response = await fetch(`${window.API_SERVER}/api/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: selectedGameId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`게임 시작 요청 오류: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('게임 데이터 로드 성공:', data);
                    
                    // script.js 함수 호출하여 게임을 실제로 시작
                    if (window.startGameWithData && typeof window.startGameWithData === 'function') {
                        window.startGameWithData(data.data);
                    } else {
                        console.error('startGameWithData 함수를 찾을 수 없습니다!');
                    }
                } else {
                    throw new Error(data.error || '게임을 시작할 수 없습니다');
                }
            } catch (error) {
                console.error('게임 시작 오류:', error);
                showErrorModal(`게임을 시작할 수 없습니다: ${error.message}`);
                
                // 버튼 다시 활성화
                startSelectedBtn.disabled = false;
                startRandomBtn.disabled = false;
            }
        }
        
        // 오류 모달 표시
        function showErrorModal(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }
    </script>
    
    <!-- 기존 스크립트 유지 -->
    <script src="script.js"></script>
</body>
</html> 